<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temp Mail API Documentation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: #f8fafc;
            color: #334155;
        }

        .api-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
        }

        .api-card:hover {
            border-color: #cbd5e1;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .api-get { border-left: 4px solid #3b82f6; }
        .api-post { border-left: 4px solid #10b981; }
        .api-delete { border-left: 4px solid #ef4444; }

        .method-badge-get {
            background-color: #dbeafe;
            color: #1e40af;
            font-weight: 600;
            font-size: 0.75rem;
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            font-family: 'JetBrains Mono', monospace;
        }

        .method-badge-post {
            background-color: #dcfce7;
            color: #166534;
            font-weight: 600;
            font-size: 0.75rem;
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            font-family: 'JetBrains Mono', monospace;
        }

        .method-badge-delete {
            background-color: #fee2e2;
            color: #991b1b;
            font-weight: 600;
            font-size: 0.75rem;
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            font-family: 'JetBrains Mono', monospace;
        }

        .session-info-card {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 8px;
        }

        .error-card {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 8px;
        }

        .form-control, .form-select {
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            padding: 0.5rem 0.75rem;
        }

        .form-control:focus, .form-select:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 0.2rem rgba(59, 130, 246, 0.25);
        }

        .btn-primary {
            background-color: #3b82f6;
            border-color: #3b82f6;
            font-weight: 500;
        }

        .btn-primary:hover {
            background-color: #2563eb;
            border-color: #2563eb;
        }

        .btn-success {
            background-color: #10b981;
            border-color: #10b981;
        }

        .btn-success:hover {
            background-color: #059669;
            border-color: #059669;
        }

        .btn-danger {
            background-color: #ef4444;
            border-color: #ef4444;
        }

        .btn-danger:hover {
            background-color: #dc2626;
            border-color: #dc2626;
        }

        .response-pre {
            background-color: #f8fafc;
            color: #334155;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 0.75rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
            max-height: 300px;
            overflow-y: auto;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .message-item-iframe {
            width: 100%;
            min-height: 200px;
            max-height: 400px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            overflow: auto;
        }

        details summary {
            cursor: pointer;
            list-style: none;
            padding: 1rem;
            border-radius: 8px;
            transition: background-color 0.2s ease;
            font-weight: 600;
        }

        details summary:hover {
            background-color: #f8fafc;
        }

        details summary::-webkit-details-marker {
            display: none;
        }

        details summary::before {
            content: '▶';
            margin-right: 0.75rem;
            display: inline-block;
            transition: transform 0.2s ease;
            font-size: 0.875rem;
            color: #6b7280;
        }

        details[open] summary::before {
            transform: rotate(90deg);
        }

        details[open] summary {
            background-color: #f1f5f9;
        }

        .back-button {
            background: white;
            border: 1px solid #e2e8f0;
            color: #3b82f6;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .back-button:hover {
            background-color: #3b82f6;
            color: white;
            text-decoration: none;
        }

        @media (max-width: 768px) {
            .container {
                padding: 0.5rem;
            }
            
            .api-card {
                margin-bottom: 1rem;
            }
            
            .method-badge-get,
            .method-badge-post,
            .method-badge-delete {
                font-size: 0.625rem;
                padding: 0.25rem 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container mx-auto py-4">
        <header class="mb-4">
            <div class="d-flex justify-content-start align-items-center mb-4">
                <a href="/" class="back-button">
                    ← Back to App
                </a>
            </div>
            <div class="text-center">
                <h1 class="display-5 fw-bold text-slate-800 mb-3">Temp Mail API Interface</h1>
                <p class="text-muted">Interact with and test the Temp Mail API endpoints.</p>
            </div>
        </header>

        <div id="globalInfo" class="session-info-card p-4 mb-4">
            <h2 class="h5 fw-semibold text-blue-700 mb-3">Current Session:</h2>
            <div class="row g-3">
                <div class="col-md-4">
                    <div class="d-flex align-items-center">
                        <strong class="me-2">Email:</strong>
                        <code id="currentEmail" class="text-blue-600 fw-semibold">N/A</code>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="d-flex align-items-center">
                        <strong class="me-2">Session ID:</strong>
                        <code id="currentSessionId" class="text-blue-600 fw-semibold">N/A</code>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="d-flex align-items-center">
                        <strong class="me-2">Provider:</strong>
                        <code id="currentProvider" class="text-blue-600 fw-semibold">N/A</code>
                    </div>
                </div>
            </div>
        </div>

        <div id="globalErrorDisplay" class="error-card p-4 mb-4 d-none">
            <h3 class="h6 fw-semibold text-red-700 mb-2">API Error:</h3>
            <pre id="globalErrorMessage" class="text-red-600 mb-0 custom-scrollbar" style="max-height: 200px; overflow-y: auto; font-size: 0.875rem;"></pre>
        </div>

        <div class="row g-4">
            <div class="col-12">
                <div class="api-card api-get">
                    <details open>
                        <summary class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
                            <div class="d-flex align-items-center mb-2 mb-md-0">
                                <span class="method-badge-get me-2">GET</span>
                                <code class="fw-semibold">/providers</code>
                            </div>
                            <span class="text-muted small">List Available Providers</span>
                        </summary>
                        <div class="p-4 pt-0">
                            <button id="fetchProvidersBtn" class="btn btn-primary mb-3">
                                Fetch Providers
                            </button>
                            <div>
                                <h4 class="h6 fw-semibold mb-2">Response:</h4>
                                <pre id="providersResponse" class="response-pre custom-scrollbar"></pre>
                            </div>
                        </div>
                    </details>
                </div>
            </div>

            <div class="col-12">
                <div class="api-card api-post">
                    <details>
                        <summary class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
                            <div class="d-flex align-items-center mb-2 mb-md-0">
                                <span class="method-badge-post me-2">POST</span>
                                <code class="fw-semibold">/gen</code>
                            </div>
                            <span class="text-muted small">Generate Email (Quick/Random)</span>
                        </summary>
                        <div class="p-4 pt-0">
                            <p class="text-muted small mb-3">Note: This endpoint also supports GET requests. Use 'random' for provider to pick randomly.</p>
                            <div class="row g-3 mb-3">
                                <div class="col-md-6">
                                    <label for="genProvider" class="form-label fw-semibold">Provider (optional):</label>
                                    <input type="text" id="genProvider" class="form-control" placeholder="e.g., mail.tm, random">
                                </div>
                                <div class="col-md-6">
                                    <label for="genRushMode" class="form-label fw-semibold">Rush Mode (tempmail.lol):</label>
                                    <select id="genRushMode" class="form-select">
                                        <option value="false">False</option>
                                        <option value="true">True</option>
                                    </select>
                                </div>
                            </div>
                            <button id="generateEmailGenBtn" class="btn btn-success mb-3">
                                Generate Email
                            </button>
                            <div>
                                <h4 class="h6 fw-semibold mb-2">Response:</h4>
                                <pre id="genResponse" class="response-pre custom-scrollbar"></pre>
                            </div>
                        </div>
                    </details>
                </div>
            </div>

            <div class="col-12">
                <div class="api-card api-post">
                    <details>
                        <summary class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
                            <div class="d-flex align-items-center mb-2 mb-md-0">
                                <span class="method-badge-post me-2">POST</span>
                                <code class="fw-semibold">/sessions</code>
                            </div>
                            <span class="text-muted small">Create Session (Specific Provider)</span>
                        </summary>
                        <div class="p-4 pt-0">
                            <div class="row g-3 mb-3">
                                <div class="col-md-6">
                                    <label for="sessionProviderName" class="form-label fw-semibold">Provider Name (required):</label>
                                    <input type="text" id="sessionProviderName" class="form-control" placeholder="e.g., mail.tm">
                                </div>
                                <div class="col-md-6">
                                    <label for="sessionRushMode" class="form-label fw-semibold">Rush Mode (tempmail.lol):</label>
                                    <select id="sessionRushMode" class="form-select">
                                        <option value="false">False</option>
                                        <option value="true">True</option>
                                    </select>
                                </div>
                            </div>
                            <button id="createSessionBtn" class="btn btn-success mb-3">
                                Create Session
                            </button>
                            <div>
                                <h4 class="h6 fw-semibold mb-2">Response:</h4>
                                <pre id="createSessionResponse" class="response-pre custom-scrollbar"></pre>
                            </div>
                        </div>
                    </details>
                </div>
            </div>

            <div class="col-12">
                <div class="api-card api-get">
                    <details>
                        <summary class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
                            <div class="d-flex align-items-center mb-2 mb-md-0">
                                <span class="method-badge-get me-2">GET</span>
                                <code class="fw-semibold">/sessions/{id}/messages</code>
                            </div>
                            <span class="text-muted small">Fetch Messages for Session</span>
                        </summary>
                        <div class="p-4 pt-0">
                            <div class="mb-3">
                                <label for="messagesSessionId" class="form-label fw-semibold">API Session ID (current if blank):</label>
                                <input type="text" id="messagesSessionId" class="form-control" placeholder="Uses current session ID">
                            </div>
                            <button id="fetchMessagesBtn" class="btn btn-primary mb-3">
                                Fetch Messages
                            </button>
                            <div>
                                <h4 class="h6 fw-semibold mb-2">Messages:</h4>
                                <div id="messagesResponse" class="p-3 bg-light border rounded custom-scrollbar" style="min-height: 100px; max-height: 500px; overflow-y: auto;">
                                    <p class="text-muted text-center mb-0">No messages fetched yet.</p>
                                </div>
                            </div>
                        </div>
                    </details>
                </div>
            </div>

            <div class="col-12">
                <div class="api-card api-delete">
                    <details>
                        <summary class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
                            <div class="d-flex align-items-center mb-2 mb-md-0">
                                <span class="method-badge-delete me-2">DELETE</span>
                                <code class="fw-semibold">/sessions/{id}/messages/{msg_id}</code>
                            </div>
                            <span class="text-muted small">Delete Specific Message</span>
                        </summary>
                        <div class="p-4 pt-0">
                            <div class="row g-3 mb-3">
                                <div class="col-md-6">
                                    <label for="deleteMessageSessionId" class="form-label fw-semibold">API Session ID (current if blank):</label>
                                    <input type="text" id="deleteMessageSessionId" class="form-control" placeholder="Uses current session ID">
                                </div>
                                <div class="col-md-6">
                                    <label for="deleteMessageId" class="form-label fw-semibold">Message ID (required):</label>
                                    <input type="text" id="deleteMessageId" class="form-control" placeholder="Enter Message ID">
                                </div>
                            </div>
                            <button id="deleteMessageBtn" class="btn btn-danger mb-3">
                                Delete Message
                            </button>
                            <div>
                                <h4 class="h6 fw-semibold mb-2">Response:</h4>
                                <pre id="deleteMessageResponse" class="response-pre custom-scrollbar"></pre>
                            </div>
                        </div>
                    </details>
                </div>
            </div>

            <div class="col-12">
                <div class="api-card api-delete">
                    <details>
                        <summary class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
                            <div class="d-flex align-items-center mb-2 mb-md-0">
                                <span class="method-badge-delete me-2">DELETE</span>
                                <code class="fw-semibold">/sessions/{api_session_id}</code>
                            </div>
                            <span class="text-muted small">Delete Session</span>
                        </summary>
                        <div class="p-4 pt-0">
                            <div class="mb-3">
                                <label for="deleteSessionId" class="form-label fw-semibold">API Session ID (current if blank):</label>
                                <input type="text" id="deleteSessionId" class="form-control" placeholder="Uses current session ID">
                            </div>
                            <button id="deleteSessionDocsBtn" class="btn btn-danger mb-3">
                                Delete Session
                            </button>
                            <div>
                                <h4 class="h6 fw-semibold mb-2">Response:</h4>
                                <pre id="deleteSessionResponse" class="response-pre custom-scrollbar"></pre>
                            </div>
                        </div>
                    </details>
                </div>
            </div>
        </div>

        <footer class="text-center text-muted mt-5 py-4">
            <small>Temp Mail API Documentation Interface &copy; 2025</small>
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        const API_BASE_URL = '';
        let G_CURRENT_SESSION_ID = null;
        let G_CURRENT_EMAIL = null;
        let G_CURRENT_PROVIDER = null;
        let G_FETCH_MESSAGES_SESSION_ID_TRACKER = null;
        let G_DISPLAYED_MESSAGE_IDS = new Set();
        const LS_DOCS_SESSION_KEY = 'tempMailApiDocsSession';

        const globalErrorDisplay = document.getElementById('globalErrorDisplay');
        const globalErrorMessage = document.getElementById('globalErrorMessage');

        function displayGlobalError(message, data = null) {
            let fullMessage = message;
            if (data && data.detail) {
                fullMessage += `\nDetails: ${typeof data.detail === 'string' ? data.detail : JSON.stringify(data.detail, null, 2)}`;
            } else if (data && typeof data === 'object') {
                fullMessage += `\n${JSON.stringify(data, null, 2)}`;
            } else if (data) {
                fullMessage += `\n${data}`;
            }
            globalErrorMessage.textContent = fullMessage;
            globalErrorDisplay.classList.remove('d-none');
            console.error("Global Error:", fullMessage, data);
        }

        function clearGlobalError() {
            globalErrorDisplay.classList.add('d-none');
            globalErrorMessage.textContent = '';
        }

        function saveDocsSessionToLocalStorage() {
            if (G_CURRENT_SESSION_ID && G_CURRENT_EMAIL && G_CURRENT_PROVIDER) {
                const sessionData = {
                    sessionId: G_CURRENT_SESSION_ID,
                    email: G_CURRENT_EMAIL,
                    provider: G_CURRENT_PROVIDER
                };
                localStorage.setItem(LS_DOCS_SESSION_KEY, JSON.stringify(sessionData));
            } else {
                localStorage.removeItem(LS_DOCS_SESSION_KEY);
            }
        }

        function loadDocsSessionFromLocalStorage() {
            const savedSession = localStorage.getItem(LS_DOCS_SESSION_KEY);
            if (savedSession) {
                try {
                    const sessionData = JSON.parse(savedSession);
                    if (sessionData.sessionId && sessionData.email && sessionData.provider) {
                        updateGlobalSessionInfo(sessionData.sessionId, sessionData.email, sessionData.provider);
                        return true;
                    }
                } catch (e) {
                    console.error("Error parsing docs session data from localStorage:", e);
                    localStorage.removeItem(LS_DOCS_SESSION_KEY);
                }
            }
            return false;
        }

        function updateGlobalSessionInfo(sessionId, email, provider) {
            G_CURRENT_SESSION_ID = sessionId;
            G_CURRENT_EMAIL = email;
            G_CURRENT_PROVIDER = provider;
            document.getElementById('currentSessionId').textContent = sessionId || 'N/A';
            document.getElementById('currentEmail').textContent = email || 'N/A';
            document.getElementById('currentProvider').textContent = provider || 'N/A';

            const messagesSessionIdInput = document.getElementById('messagesSessionId');
            const deleteSessionIdInput = document.getElementById('deleteSessionId');
            const deleteMessageSessionIdInput = document.getElementById('deleteMessageSessionId');

            const placeholderBase = 'Current: ';
            const placeholderEnter = 'Enter Session ID';

            if (sessionId) {
                const shortSessionId = sessionId.length > 15 ? `${sessionId.substring(0,10)}...` : sessionId;
                const placeholderText = `${placeholderBase}${shortSessionId}`;
                messagesSessionIdInput.placeholder = placeholderText;
                deleteSessionIdInput.placeholder = placeholderText;
                deleteMessageSessionIdInput.placeholder = placeholderText;
            } else {
                messagesSessionIdInput.placeholder = placeholderEnter;
                deleteSessionIdInput.placeholder = placeholderEnter;
                deleteMessageSessionIdInput.placeholder = placeholderEnter;
            }
            if (G_FETCH_MESSAGES_SESSION_ID_TRACKER !== sessionId) {
                const messagesContainer = document.getElementById('messagesResponse');
                messagesContainer.innerHTML = '<p class="text-muted text-center mb-0">No messages fetched yet for this session.</p>';
                G_DISPLAYED_MESSAGE_IDS.clear();
            }
            G_FETCH_MESSAGES_SESSION_ID_TRACKER = sessionId;
            saveDocsSessionToLocalStorage();
        }

        function escapeForSrcdoc(str) {
            if (typeof str !== 'string') return '';
            return str
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;')
                .replace(/`/g, '\\`')
                .replace(/\$\{/g, '\\${');
        }

        async function apiRequest(endpoint, method = 'GET', body = null, params = null, buttonElement = null) {
            clearGlobalError();
            const originalButtonText = buttonElement ? buttonElement.innerHTML : null;
            if (buttonElement) {
                buttonElement.disabled = true;
                buttonElement.innerHTML = `
                    <div class="spinner-border spinner-border-sm me-2" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    Processing...
                `;
            }

            const url = new URL(`${API_BASE_URL}${endpoint}`, window.location.origin);
            if (params) {
                Object.keys(params).forEach(key => {
                    if (params[key] !== null && params[key] !== undefined && params[key] !== '') {
                        url.searchParams.append(key, params[key]);
                    }
                });
            }

            const options = { method, headers: {} };
            if (body) {
                options.headers['Content-Type'] = 'application/json';
                options.body = JSON.stringify(body);
            }

            try {
                const response = await fetch(url, options);
                if (buttonElement && originalButtonText) buttonElement.innerHTML = originalButtonText;

                if (response.status === 204) {
                    if (buttonElement) buttonElement.disabled = false;
                    return { success: true, status: 204, data: null };
                }

                let responseData;
                const contentType = response.headers.get("content-type");
                if (contentType && contentType.includes("application/json")) {
                    responseData = await response.json();
                } else {
                    const textResponse = await response.text();
                    if (response.ok) {
                        responseData = { detail: "Response was not JSON, but status was OK.", content: textResponse };
                    } else {
                        responseData = { detail: `Server returned non-JSON response with status ${response.status}`, content: textResponse };
                    }
                }

                if (!response.ok) {
                    throw { status: response.status, data: responseData };
                }
                if (buttonElement) buttonElement.disabled = false;
                return { success: true, status: response.status, data: responseData };
            } catch (error) {
                console.error(`API Request Error (${method} ${endpoint}):`, error);
                const errorMessageText = error.data ? (error.data.detail || (typeof error.data === 'string' ? error.data : JSON.stringify(error.data))) : error.message || 'Network error or invalid/unexpected response';
                displayGlobalError(`Error ${error.status || 'Network'}: ${errorMessageText}`, error.data);
                if (buttonElement && originalButtonText) {
                    buttonElement.innerHTML = originalButtonText;
                    buttonElement.disabled = false;
                }
                return { success: false, status: error.status, error: error.data || { detail: errorMessageText } };
            }
        }

        function displayMessageInDocs(containerId, messageData, append = false) {
            const container = document.getElementById(containerId);
            if (!append) {
                container.innerHTML = '';
                G_DISPLAYED_MESSAGE_IDS.clear();
            }

            const placeholder = container.querySelector('p.text-muted.text-center');
            if (messageData && messageData.length > 0 && placeholder) {
                placeholder.remove();
            } else if ((!messageData || messageData.length === 0) && !append && !placeholder) {
                container.innerHTML = '<p class="text-muted text-center mb-0">No messages found.</p>';
                return;
            } else if ((!messageData || messageData.length === 0) && append && container.querySelectorAll('.message-item').length === 0) {
                container.innerHTML = '<p class="text-muted text-center mb-0">No new messages.</p>';
                return;
            }

            messageData.forEach(msg => {
                if (G_DISPLAYED_MESSAGE_IDS.has(msg.id) && append) return;

                const msgDiv = document.createElement('div');
                msgDiv.className = 'p-3 border rounded mb-3 bg-white message-item';
                msgDiv.setAttribute('data-message-id', msg.id);

                let fromDisplay = msg.from_address || 'Unknown Sender';
                if (msg.raw && typeof msg.raw.from === 'string' && msg.raw.from.trim() !== '') {
                    fromDisplay = msg.raw.from;
                } else if (msg.raw && typeof msg.raw.mail_from === 'string' && msg.raw.mail_from.trim() !== '') {
                    fromDisplay = msg.raw.mail_from;
                }

                let subjectText = msg.subject || '(No Subject)';
                let dateText = msg.date ? new Date(msg.date).toLocaleString() : 'Unknown Date';
                let bodyText = msg.body || '(No text body)';
                let htmlContent = msg.html ? escapeForSrcdoc(Array.isArray(msg.html) ? msg.html.join('') : String(msg.html)) : '';

                const uniqueDetailsId = `msg-details-${msg.id}-${Date.now()}`;

                msgDiv.innerHTML = `
                    <div class="border-bottom pb-3 mb-3">
                        <p class="small text-muted mb-1">ID: <code class="text-primary">${msg.id}</code></p>
                        <p class="mb-1"><strong>From:</strong> <span class="text-dark">${escapeForSrcdoc(fromDisplay)}</span></p>
                        <p class="mb-1"><strong>Subject:</strong> <span class="text-dark">${escapeForSrcdoc(subjectText)}</span></p>
                        <p class="small text-muted mb-0"><strong>Date:</strong> ${dateText}</p>
                    </div>
                    <details class="small" id="${uniqueDetailsId}">
                        <summary class="text-primary fw-semibold" style="cursor: pointer;">
                            Show Body/HTML ▼
                        </summary>
                        <div class="mt-2 p-3 bg-light border rounded">
                            <p class="fw-semibold text-dark small mb-2">Text Body:</p>
                            <pre class="bg-white border rounded p-2 small custom-scrollbar" style="max-height: 200px; overflow-y: auto; white-space: pre-wrap;">${escapeForSrcdoc(bodyText)}</pre>
                            ${htmlContent ? `
                                <p class="fw-semibold text-dark small mt-3 mb-2">HTML Body:</p>
                                <iframe srcdoc="<html><head><base target='_blank'><style>body{font-family:sans-serif;padding:8px;overflow-wrap:break-word;}img{max-width:100%;height:auto;}table{border-collapse:collapse;width:100%;}th,td{border:1px solid #ddd;padding:4px;text-align:left;}</style></head><body>${htmlContent}</body></html>" sandbox="allow-popups allow-popups-to-escape-sandbox allow-same-origin" class="message-item-iframe"></iframe>
                            ` : '<p class="small text-muted mt-2">(No HTML body)</p>'}
                        </div>
                    </details>
                `;
                if (append && container.firstChild && !container.querySelector('p.text-muted.text-center')) {
                    container.insertBefore(msgDiv, container.firstChild);
                } else {
                    container.appendChild(msgDiv);
                }
                if (append) G_DISPLAYED_MESSAGE_IDS.add(msg.id);
            });
        }

        document.getElementById('fetchProvidersBtn').addEventListener('click', async (e) => {
            const result = await apiRequest('/providers', 'GET', null, null, e.target);
            document.getElementById('providersResponse').textContent = result.success ? JSON.stringify(result.data, null, 2) : (result.error?.detail || 'Error fetching providers.');
        });

        document.getElementById('generateEmailGenBtn').addEventListener('click', async (e) => {
            const provider = document.getElementById('genProvider').value || null;
            const rushMode = document.getElementById('genRushMode').value === 'true';
            const params = {};
            if (provider && provider.toLowerCase() !== 'random') {
                params.provider = provider;
            }
            if ((provider && provider.toLowerCase() === 'tempmail.lol') || !provider || provider.toLowerCase() === 'random') {
                params.rush_mode = rushMode;
            }

            const result = await apiRequest('/gen', 'POST', null, params, e.target);
            document.getElementById('genResponse').textContent = result.success ? JSON.stringify(result.data, null, 2) : (result.error?.detail || 'Error generating email.');
            if (result.success && result.data) {
                updateGlobalSessionInfo(result.data.api_session_id, result.data.email_address, result.data.provider);
            }
        });

        document.getElementById('createSessionBtn').addEventListener('click', async (e) => {
            const providerName = document.getElementById('sessionProviderName').value;
            const rushMode = document.getElementById('sessionRushMode').value === 'true';
            if (!providerName) {
                displayGlobalError("Provider Name is required for creating a specific session.");
                return;
            }
            const params = { provider_name: providerName };
            if (providerName.toLowerCase() === 'tempmail.lol') params.rush_mode = rushMode;

            const result = await apiRequest('/sessions', 'POST', null, params, e.target);
            document.getElementById('createSessionResponse').textContent = result.success ? JSON.stringify(result.data, null, 2) : (result.error?.detail || 'Error creating session.');
            if (result.success && result.data) {
                updateGlobalSessionInfo(result.data.api_session_id, result.data.email_address, result.data.provider);
            }
        });

        document.getElementById('fetchMessagesBtn').addEventListener('click', async (e) => {
            const sessionIdInput = document.getElementById('messagesSessionId').value;
            const sessionIdToUse = sessionIdInput || G_CURRENT_SESSION_ID;

            if (!sessionIdToUse) {
                displayGlobalError("No session ID specified or active. Please generate or create an email session first.");
                return;
            }

            const isNewSessionForFetch = G_FETCH_MESSAGES_SESSION_ID_TRACKER !== sessionIdToUse;
            if (isNewSessionForFetch) {
                document.getElementById('messagesResponse').innerHTML = '<p class="text-muted text-center mb-0">Fetching messages...</p>';
                G_DISPLAYED_MESSAGE_IDS.clear();
                G_FETCH_MESSAGES_SESSION_ID_TRACKER = sessionIdToUse;
            }

            const result = await apiRequest(`/sessions/${sessionIdToUse}/messages`, 'GET', null, null, e.target);
            if (result.success) {
                displayMessageInDocs('messagesResponse', result.data, !isNewSessionForFetch);
            } else {
                const messagesResponseDiv = document.getElementById('messagesResponse');
                if(messagesResponseDiv.querySelectorAll('.message-item').length === 0) {
                    messagesResponseDiv.innerHTML = `<p class="text-danger text-center mb-0">Error fetching messages. ${result.error?.detail || ''}</p>`;
                }
            }
        });

        document.getElementById('deleteMessageBtn').addEventListener('click', async (e) => {
            const sessionIdInput = document.getElementById('deleteMessageSessionId').value;
            const messageId = document.getElementById('deleteMessageId').value;
            const sessionIdToUse = sessionIdInput || G_CURRENT_SESSION_ID;

            if (!sessionIdToUse) {
                displayGlobalError("No API Session ID specified or active.");
                return;
            }
            if (!messageId) {
                displayGlobalError("Message ID is required to delete a message.");
                return;
            }

            const result = await apiRequest(`/sessions/${sessionIdToUse}/messages/${messageId}`, 'DELETE', null, null, e.target);
            const responseOutput = document.getElementById('deleteMessageResponse');
            if (result.success && result.status === 204) {
                responseOutput.textContent = `Message ${messageId} marked for deletion from session ${sessionIdToUse.substring(0,10)}... (Status: 204 No Content). Refresh messages to see changes.`;
                if (sessionIdToUse === G_FETCH_MESSAGES_SESSION_ID_TRACKER) {
                    const msgElement = document.querySelector(`#messagesResponse .message-item[data-message-id="${messageId}"]`);
                    if (msgElement) {
                        msgElement.remove();
                    }
                    G_DISPLAYED_MESSAGE_IDS.delete(messageId);
                    if (document.getElementById('messagesResponse').querySelectorAll('.message-item').length === 0) {
                        document.getElementById('messagesResponse').innerHTML = '<p class="text-muted text-center mb-0">No messages found (or last one deleted).</p>';
                    }
                }
            } else {
                responseOutput.textContent = `Failed to delete message ${messageId}. Status: ${result.status || 'N/A'}. ${result.error?.detail || ''}`;
            }
        });

        document.getElementById('deleteSessionDocsBtn').addEventListener('click', async (e) => {
            const sessionIdInput = document.getElementById('deleteSessionId').value;
            const sessionIdToUse = sessionIdInput || G_CURRENT_SESSION_ID;
            if (!sessionIdToUse) {
                displayGlobalError("No session ID specified or active to delete.");
                return;
            }
            const result = await apiRequest(`/sessions/${sessionIdToUse}`, 'DELETE', null, null, e.target);
            const responseEl = document.getElementById('deleteSessionResponse');
            responseEl.textContent = result.success ? `Session ${sessionIdToUse.substring(0,15)}... deleted (Status: ${result.status})` : `Failed to delete (Status: ${result.status || 'N/A'}). ${result.error?.detail || ''}`;
            if (result.success && sessionIdToUse === G_CURRENT_SESSION_ID) {
                updateGlobalSessionInfo(null, null, null);
                document.getElementById('messagesResponse').innerHTML = '<p class="text-muted text-center mb-0">Current session deleted. Generate a new one to continue.</p>';
                G_DISPLAYED_MESSAGE_IDS.clear();
            }
        });

        (async () => {
            loadDocsSessionFromLocalStorage();
            const btn = document.getElementById('fetchProvidersBtn');
            if (btn) {
                const result = await apiRequest('/providers', 'GET', null, null, btn);
                const providersResponseEl = document.getElementById('providersResponse');
                if (providersResponseEl) {
                    providersResponseEl.textContent = result.success ? JSON.stringify(result.data, null, 2) : (result.error?.detail || 'Error fetching providers on load.');
                }
            }
            if (!G_CURRENT_SESSION_ID) {
                document.getElementById('messagesResponse').innerHTML = '<p class="text-muted text-center mb-0">Generate or create a session to see messages.</p>';
            }
        })();
    </script>
</body>
</html>